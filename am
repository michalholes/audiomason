#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks so this works even when called via /usr/local/bin/am
resolve_self() {
  local src="$1"
  while [ -L "$src" ]; do
    local dir
    dir="$(cd -P "$(dirname "$src")" && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done
  cd -P "$(dirname "$src")" && pwd
}

ROOT="$(resolve_self "$0")"
VENV_BIN="$ROOT/.venv/bin"
AM="$VENV_BIN/audiomason"

if [[ -x "$AM" ]]; then
  exec "$AM" "$@"
fi

echo "FATAL: $AM not found/executable" >&2
echo "Hint: cd '$ROOT' && python3 -m venv .venv && source .venv/bin/activate && pip install -e ." >&2
exit 127
